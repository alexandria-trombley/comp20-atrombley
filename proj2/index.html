<!DOCTYPE html>

<html>

<head>
	<meta charset="utf-8" />
	<title>Map Chat</title>
	
</head>

<script>
// retrieves message from text box, and prints it out on the screen
function retrieveMessage() {

	navigator.geolocation.getCurrentPosition(function(position) {

		// retrieves message input by user
		var mess = document.getElementById("message").value;
		document.getElementById("output").innerHTML = mess;

		// determines the location of the user
		var longitude = position.coords.longitude;
		var latitude = position.coords.latitude;

		document.getElementById("my_location").innerHTML = 'latitude:' + "  " + latitude + '<br>' +
		 'longitude:' + "   " + longitude;

		// creates new HTTP request object 
		// this will be used to get info from server
		var myRequest = new XMLHttpRequest();

		// parses the data when it has been returned from the server
		myRequest.onreadystatechange = function() {
	
			if (myRequest.readyState == 4 && myRequest.status == 200) {
		
				var data = JSON.parse(myRequest.responseText);
				print(data, latitude, longitude);
	
			} 

			//PUT IN IF STATEMENT HERE

		}

		// sends user information to post to server
		myRequest.open("POST", "https://secret-about-box.herokuapp.com/sendLocation", true);
		myRequest.setRequestHeader("Content-type","application/x-www-form-urlencoded");

		// make sure all information is in string format
		var YOUR_LATITUDE = latitude.toString();
		var YOUR_LONGITUDE = longitude.toString();
		var sendMessage = "login=LeaAmmerman&lat=" + YOUR_LATITUDE + "&lng=" + YOUR_LONGITUDE + "&message=" + mess;		
		myRequest.send(sendMessage);
				
	});

	

}

function print(data, lat, long) {	

	var out = "  ";
	
	Number.prototype.toRad = function () {
		return this * Math.PI / 180;
	}

	for (i = 0; i < data.length; i++) {

		// Use the haversine formula to calculate the distance between self and other
		// classmates 
		var lat2 = data[i].lat;
		var long2 = data[i].lng;
		var R = 6371;

		var x1 = lat2 - lat;
		var dLat = x1.toRad();
		var x2 = long2 - long;
		var dLong = x2.toRad();
		var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat.toRad()) * Math.cos(lat2.toRad()) * Math.sin(dLong/2) * Math.sin(dLong/2);
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
		var distance = R * c;
		
		// tell the user how far everyone in class is from them via screen
		out += data[i].login + " is " + distance + " miles from you." + '<br>';
		document.getElementById("test").innerHTML = out;
	
	}	

}

</script>

<body>

	<!--takes in a message from the user, then JavaScript manipulates it-->
	Input your message here: <br>
	<input type="text" id="message">
	<button onclick="retrieveMessage()">Go!</button>
	<div id="output"></div>

	<!--where the location information is loaded-->
	<div id="my_location"></div>

	<!--where the class data information is recorded-->
	<div id="class_data"></div>

	<div id="test"></div>

</body>

</html>
